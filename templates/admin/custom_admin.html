{% extends "admin/base_site.html" %}
{% block content %}

  <!-- Основной контейнер для чата -->
  <div style="display: flex; height: 90vh; border: 1px solid #ccc; border-radius: 10px; overflow: hidden;">

    <!-- Левая колонка со списком пользователей -->
    <div id="user-list" style="width: 30%; background-color: #2b2b2b; padding: 10px; overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none;">
      {% for user in users %}
        <div class="user-item" data-user-id="{{ user.id }}" data-user-name="{{ user.full_name|default:user.phone_number }}" style="padding: 15px; margin-bottom: 5px; background-color: #3b3b3b; color: white; border-radius: 8px; cursor: pointer;">
          <div>{{ user.full_name|default:user.phone_number }}</div>
        </div>
      {% endfor %}
    </div>

    <!-- Правая колонка с чатом -->
    <div id="chat-box-container" style="flex-grow: 1; padding: 10px; background-color: #1e1e1e; color: #fff; border-left: 1px solid #444; display: flex; flex-direction: column;">

      <!-- Здесь будет отображаться имя пользователя или номер телефона -->
      <div id="chat-user-header" style="padding: 10px; background-color: #2b2b2b; color: #fff; font-weight: bold; margin-bottom: 10px; border-radius: 8px; text-align: center;">
        Выберите пользователя
      </div>

      <!-- Чат -->
      <div id="chat-box" style="flex-grow: 1; overflow-y: auto; background-color: #2b2b2b; padding: 10px; border-radius: 10px; border: 1px solid #444; scrollbar-width: none; -ms-overflow-style: none;"></div>

      <!-- Ввод сообщения и загрузка изображения -->
      <div class="message-input" style="display: flex; align-items: center; margin-top: 10px;">
        <textarea id="message-box" placeholder="Напишите сообщение..." style="width: 100%; height: 50px; margin-right: 10px; border-radius: 5px; border: 1px solid #444; padding: 10px; background-color: #3b3b3b; color: white; resize: none;"></textarea>

        <!-- Поле для загрузки изображения -->
        <input type="file" id="image-upload" accept="image/*" style="margin-right: 10px;" />

        <button id="send-button" style="height: 50px; background-color: #0066cc; color: white; border: none; padding: 0 20px; border-radius: 5px; cursor: pointer;">Отправить</button>
      </div>
    </div>

    <!-- Модальное окно для изображения -->
    <div id="image-modal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8);">
      <span id="close-modal" style="position: absolute; top: 20px; right: 35px; color: white; font-size: 40px; cursor: pointer;">&times;</span>
      <img id="modal-image" style="margin: auto; display: block; max-width: 80%; max-height: 80%;" />
    </div>

  </div>

  <!-- Подключение Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>

  <script>
    // Инициализация Firebase
    var firebaseConfig = {
      apiKey: "AIzaSyDKRy-VqxzT4biCFsXnKbQq-o3qdT_quyk",
      authDomain: "yummi-sushi-5ecf2.firebaseapp.com",
      projectId: "yummi-sushi-5ecf2",
      storageBucket: "yummi-sushi-5ecf2.appspot.com",
      messagingSenderId: "795227736482",
      appId: "1:795227736482:web:24f9d6ea912dedc217cafb",
      measurementId: "G-6XT1HLCQDD"
    };

    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();
    var storage = firebase.storage();

    var selectedUserId = null;
    var adminId = {{ admin_id }};
    var selectedChatId = null;

    // Подписка на все чаты при загрузке страницы
    subscribeToAllChats();

    function subscribeToAllChats() {
      console.log("Подписка на все чаты");
      let userIds = [{% for user in users %} {{ user.id }}, {% endfor %}];

      userIds.forEach(function(userId) {
        fetchChatId(userId).then(function(chatId) {
          if (chatId) {
            subscribeToChat(chatId, userId);
          }
        });
      });
    }

    // Логика выбора пользователя
    document.querySelectorAll('.user-item').forEach(function(item) {
      item.addEventListener('click', function() {
        document.querySelectorAll('.user-item').forEach(function(user) {
          user.style.backgroundColor = '#3b3b3b';
        });
        this.style.backgroundColor = '#0066cc';
        selectedUserId = Number(this.getAttribute('data-user-id'));
        var userNameOrPhone = this.getAttribute('data-user-name');
        document.getElementById('chat-user-header').innerText = userNameOrPhone;
        loadMessages(selectedUserId);
      });
    });

    // Функция загрузки сообщений
    function loadMessages(userId) {
      fetchChatId(userId).then(function(chatId) {
        if (chatId) {
          selectedChatId = chatId;
          subscribeToChat(chatId, userId);
        } else {
          selectedChatId = null;
          document.getElementById('chat-box').innerHTML = 'Нет сообщений. Начните новый чат.';
        }
      });
    }

    // Функция проверки, существует ли чат
    function fetchChatId(userId) {
      return fetch(`/api/v2/chat/get-chat-id/?user_id=${userId}&admin_id=${adminId}`)
        .then(response => response.json())
        .then(data => {
          console.log("Полученный chat_id:", data.chat_id); // Лог для проверки
          return data.chat_id || null;
        });
    }

    // Подписка на сообщения в реальном времени для конкретного чата
    function subscribeToChat(chatId, userId) {
      if (!chatId) return;
      console.log("Подписка на чат с ID:", chatId);
      console.log("Тип chatId:", typeof chatId);  // Добавьте этот лог

      chatId = chatId.toString(); // Приводим к строке, если это необходимо
      db.collection('chats').doc(chatId).collection('messages')
        .orderBy('timestamp')
        .onSnapshot(function(querySnapshot) {
          let messages = [];
          querySnapshot.forEach(function(doc) {
            var messageData = doc.data();
            messages.push(messageData);
          });
          if (userId === selectedUserId) {
            document.getElementById('chat-box').innerHTML = '';
            messages.forEach(messageData => displayMessage(messageData));
            document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
          }
        });
    }

    // Отображение сообщения в чате
function displayMessage(messageData) {
  var chatBox = document.getElementById('chat-box');
  var messageCover = document.createElement('div');
  messageCover.style.display = "flex";
  messageCover.style.flexDirection = "row";
  messageCover.style.width = "100%";
  messageCover.classList.add('cover');

  var messageElement = document.createElement('div');
  messageElement.style.padding = '10px';
  messageElement.style.borderRadius = '8px';
  messageElement.style.width = 'fit-content';
  messageElement.style.color = '#fff';
  messageCover.appendChild(messageElement);

  // Проверка, если сообщение от админа, отображаем его справа
  if (messageData.sender_id == adminId) {
    messageElement.style.backgroundColor = "#0066cc"; // Синий фон для сообщений админа
    messageCover.style.justifyContent = 'flex-end';  // Сообщения админа справа
  } else {
    messageElement.style.backgroundColor = "#3b3b3b"; // Серый фон для сообщений пользователя
    messageCover.style.justifyContent = 'flex-start';  // Сообщения пользователя слева
  }

  var messageContent = `<strong>${messageData.sender_full_name}</strong>: ${messageData.content || ''} <br> <small>${new Date(messageData.timestamp.seconds * 1000).toLocaleString()}</small>`;

  // Проверяем, если есть URL изображения
  if (messageData.image_url) {
    messageContent += `<br><img src="${messageData.image_url}" alt="Image" class="chat-image" style="max-width: 200px; border-radius: 8px; margin-top: 10px; cursor: pointer;">`;
  }

  messageElement.innerHTML = messageContent;
  chatBox.appendChild(messageCover);

  // Добавляем обработчик для открытия изображения в модальном окне
  var chatImage = messageElement.querySelector('.chat-image');
  if (chatImage) {
    chatImage.addEventListener('click', function() {
      openImageModal(messageData.image_url);
    });
  }
}


    // Открытие модального окна с изображением
    function openImageModal(imageUrl) {
      var modal = document.getElementById('image-modal');
      var modalImage = document.getElementById('modal-image');
      modalImage.src = imageUrl;
      modal.style.display = "block";
    }

    // Закрытие модального окна
    var closeModal = document.getElementById('close-modal');
    closeModal.addEventListener('click', function() {
      var modal = document.getElementById('image-modal');
      modal.style.display = "none";
    });

    // Закрытие модального окна при клике вне изображения
    window.addEventListener('click', function(event) {
      var modal = document.getElementById('image-modal');
      if (event.target == modal) {
        modal.style.display = "none";
      }
    });

    // Отправка сообщения
    document.getElementById('send-button').addEventListener('click', function() {
      var messageContent = document.getElementById('message-box').value;
      var imageFile = document.getElementById('image-upload').files[0];
      if (!messageContent && !imageFile) {
        alert('Введите сообщение или выберите изображение.');
        return;
      }
      if (!selectedUserId) {
        alert('Выберите пользователя.');
        return;
      }
      sendMessageToExistingChat(selectedChatId, messageContent, imageFile);
      document.getElementById('message-box').value = "";
      document.getElementById('image-upload').value = "";
    });

    // Отправка сообщения в существующий чат с фото
    function sendMessageToExistingChat(chatId, messageContent, imageFile) {
      if (imageFile) {
        uploadImageToFirestore(imageFile).then(imageUrl => {
          sendMessage(chatId, messageContent, imageUrl);
        }).catch(error => {
          console.error("Ошибка загрузки изображения:", error);
        });
      } else {
        sendMessage(chatId, messageContent, null);
      }
    }

    // Функция отправки сообщения в Firestore
    function sendMessage(chatId, messageContent, imageUrl) {
      console.log("Отправка сообщения с данными:", {
          sender_id: adminId,
          recipient_id: selectedUserId,
          content: messageContent,
          image_url: imageUrl
      });

      // Приводим adminId и selectedUserId к строкам
      const senderId = String(adminId);
      const recipientId = String(selectedUserId);
      const chatDocId = String(chatId);

      // Проверяем типы данных перед отправкой
      console.log("Типы данных:");
      console.log("adminId:", typeof senderId, "значение:", senderId);
      console.log("selectedUserId:", typeof recipientId, "значение:", recipientId);
      console.log("chatId:", typeof chatDocId, "значение:", chatDocId);

      db.collection('chats').doc(chatDocId).collection('messages').add({
          sender_id: senderId,  // Приведение к строке
          sender_full_name: 'Admin',
          recipient_id: recipientId,  // Приведение к строке
          content: messageContent || '',
          image_url: imageUrl || null,
          timestamp: new Date()  // Дата в правильном формате
      }).then(() => {
          console.log("Сообщение отправлено.");
      }).catch((error) => {
          console.error("Ошибка при отправке сообщения:", error);
      });
    }

    // Функция для загрузки изображения в Firebase Storage
    function uploadImageToFirestore(imageFile) {
      return new Promise((resolve, reject) => {
        var storageRef = storage.ref().child('message_images/' + imageFile.name);
        var uploadTask = storageRef.put(imageFile);

        uploadTask.on('state_changed',
          function(snapshot) {
            var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            console.log('Загрузка изображения: ' + progress + '% завершено');
          },
          function(error) {
            console.error("Ошибка загрузки изображения:", error);
            reject(error);
          },
          function() {
            // Получаем ссылку на загруженное изображение
            uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
              console.log("Изображение загружено. URL:", downloadURL); // Логируем URL изображения
              resolve(downloadURL);
            }).catch(function(error) {
              console.error("Ошибка при получении URL изображения:", error);
              reject(error);
            });
          }
        );
      });
    }
  </script>

  <!-- Стили -->
  <style>
    #user-list::-webkit-scrollbar,
    #chat-box::-webkit-scrollbar {
      display: none;
    }
    #user-list, #chat-box {
      scrollbar-width: none;
    }
    textarea#message-box {
      resize: none;
      scrollbar-width: none;
    }
    #chat-box {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    #image-modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);

      /* Flexbox для идеального центрирования */
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #modal-image {
      max-width: 80%;
      max-height: 80%;
      object-fit: contain; /* Убедитесь, что изображение сохраняет свои пропорции */
    }
    #close-modal {
      position: fixed;
      top: 20px;
      right: 35px;
      color: white;
      font-size: 40px;
      cursor: pointer;
    }
    .message-user {
  justify-content: flex-start;
  background-color: #3b3b3b;
    }

    /* Сообщения админа отображаются справа */
    .message-admin {
      justify-content: flex-end;
      background-color: #0066cc;
    }
  </style>

{% endblock %}
